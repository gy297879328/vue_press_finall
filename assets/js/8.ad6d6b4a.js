(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{505:function(s,a,t){s.exports=t.p+"assets/img/concurrency_tp.ca5368f1.png"},506:function(s,a,t){s.exports=t.p+"assets/img/java-jmm-1.b098a84e.png"},507:function(s,a){s.exports="data:image/png;base64,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"},508:function(s,a,t){s.exports=t.p+"assets/img/java-jmm-3.24c77803.png"},509:function(s,a,t){s.exports=t.p+"assets/img/java-jmm-4.95c5a415.png"},510:function(s,a,t){s.exports=t.p+"assets/img/java-jmm-5.f5e54ed7.png"},511:function(s,a,t){s.exports=t.p+"assets/img/java-jmm-06.fc8fe8fd.png"},549:function(s,a,t){"use strict";t.r(a);var n=t(7),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"知识图谱"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#知识图谱"}},[s._v("#")]),s._v(" 知识图谱")]),s._v(" "),n("p",[n("img",{attrs:{src:t(505),alt:"concurrency_tp"}})]),s._v(" "),n("h2",{attrs:{id:"前言"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),n("p",[s._v("网上并发以及JMM部分的内容大部分都特别的乱，也不好整理。花了三四天时间才整理了一篇，有些概念的东西，是需要了解的，也标注出来了。")]),s._v(" "),n("p",[n("strong",[s._v("标注：在学习中需要修改的内容以及笔记全在这里 "),n("a",{attrs:{href:"https://juejin.cn/post/www.javanode.cn",target:"_blank",rel:"noopener noreferrer"}},[s._v("www.javanode.cn"),n("OutboundLink")],1),s._v("，谢谢！有任何不妥的地方望纠正")])]),s._v(" "),n("h2",{attrs:{id:"并发编程的优缺点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#并发编程的优缺点"}},[s._v("#")]),s._v(" 并发编程的优缺点")]),s._v(" "),n("h3",{attrs:{id:"_1-为什么要用到并发"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-为什么要用到并发"}},[s._v("#")]),s._v(" 1. 为什么要用到并发")]),s._v(" "),n("p",[s._v("多核的CPU的背景下，催生了并发编程的趋势，通过"),n("strong",[s._v("并发编程的形式可以将多核CPU的计算能力发挥到极致，性能得到提升")])]),s._v(" "),n("p",[n("strong",[s._v("面对复杂业务模型，并行程序会比串行程序更适应业务需求，而并发编程更能吻合这种业务拆分")])]),s._v(" "),n("h3",{attrs:{id:"_2-并发编程有哪些缺点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-并发编程有哪些缺点"}},[s._v("#")]),s._v(" 2. 并发编程有哪些缺点")]),s._v(" "),n("h4",{attrs:{id:"_2-1-频繁的上下文切换"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-频繁的上下文切换"}},[s._v("#")]),s._v(" 2.1 频繁的上下文切换")]),s._v(" "),n("p",[s._v("时间片是CPU分配给各个线程的时间，因为时间非常短，所以"),n("strong",[s._v("CPU不断通过切换线程")]),s._v("，让我们觉得多个线程是同时执行的，时间片一般是几十毫秒。而每次切换时，需要保存当前的状态起来，以便能够进行恢复先前状态，而这个切换时非常损耗性能，"),n("strong",[s._v("过于频繁反而无法发挥出多线程编程的优势")]),s._v("。"),n("strong",[s._v("通常减少上下文切换可以采用无锁并发编程，CAS算法，使用最少的线程和使用协程")]),s._v("。")]),s._v(" "),n("h4",{attrs:{id:"_2-2-线程安全"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-线程安全"}},[s._v("#")]),s._v(" 2.2 线程安全")]),s._v(" "),n("p",[s._v("多线程编程中最难以把握的就是"),n("strong",[s._v("临界区线程安全问题")]),s._v("，稍微不注意就会出现死锁的情况，一旦产生死锁就会造成系统功能不可用。")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DeadLockDemo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" resource_a "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"A"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" resource_b "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"B"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("deadLock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("deadLock")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),s._v(" threadA "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Runnable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resource_a"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get resource a"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resource_b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                            "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get resource b"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("printStackTrace")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),s._v(" threadB "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Runnable")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resource_b"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get resource b"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resource_a"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                        "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v('"get resource a"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        threadA"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        threadB"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("start")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br")])]),n("p",[s._v("通常可以用如下方式"),n("strong",[s._v("避免死锁")]),s._v("的情况")]),s._v(" "),n("ol",[n("li",[s._v("避免一个线程同时获得多个锁；")]),s._v(" "),n("li",[s._v("避免一个线程在锁内部占有多个资源，尽量保证每个锁只占用一个资源")]),s._v(" "),n("li",[s._v("尝试使用定时锁，使用lock.tryLock(timeOut)，当超时等待时当前线程不会阻塞；")]),s._v(" "),n("li",[s._v("对于数据库锁，加锁和解锁必须在一个数据库连接里，否则会出现解锁失败的情况")])]),s._v(" "),n("h2",{attrs:{id:"并发三要素-了解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#并发三要素-了解"}},[s._v("#")]),s._v(" 并发三要素（了解）")]),s._v(" "),n("h3",{attrs:{id:"可见性-cpu缓存引起"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#可见性-cpu缓存引起"}},[s._v("#")]),s._v(" 可见性: CPU缓存引起")]),s._v(" "),n("p",[s._v("可见性：当多个线程访问同一个变量时，如果其中一个线程对其作了修改，其他线程能立即获取到最新的值。")]),s._v(" "),n("h3",{attrs:{id:"原子性-分时复用引起"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#原子性-分时复用引起"}},[s._v("#")]),s._v(" 原子性: 分时复用引起")]),s._v(" "),n("p",[s._v("原子性：即一个操作或者多个操作 要么全部执行并且执行的过程不会被任何因素打断，要么就都不执行")]),s._v(" "),n("h3",{attrs:{id:"有序性-重排序引起"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#有序性-重排序引起"}},[s._v("#")]),s._v(" 有序性: 重排序引起")]),s._v(" "),n("p",[s._v("程序执行的顺序按照代码的先后顺序执行。（处理器可能会对指令进行重排序）")]),s._v(" "),n("p",[s._v("在执行程序时为了提高性能，编译器和处理器常常会对指令做重排序。"),n("strong",[s._v("重排序分三种类型")]),s._v("：")]),s._v(" "),n("ul",[n("li",[s._v("编译器优化的重排序。编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序。")]),s._v(" "),n("li",[s._v("指令级并行的重排序。现代处理器采用了指令级并行技术（Instruction-Level Parallelism， ILP）来将多条指令重叠执行。如果不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序。")]),s._v(" "),n("li",[s._v("内存系统的重排序。由于处理器使用缓存和读 / 写缓冲区，这使得加载和存储操作看上去可能是在乱序执行。")])]),s._v(" "),n("h2",{attrs:{id:"并发核心概念-了解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#并发核心概念-了解"}},[s._v("#")]),s._v(" 并发核心概念(了解)")]),s._v(" "),n("h3",{attrs:{id:"并发与并行-重要"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#并发与并行-重要"}},[s._v("#")]),s._v(" 并发与并行(重要)")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("第一种")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("在单CPU系统中，系统调度在某一时刻只能让一个线程运行，虽然这种调试机制有多种形式(大多数是时间片轮巡为主)，但无论如何，要通过不断切换需要运行的线程让其运行的方式就叫并发(concurrent)。")])]),s._v(" "),n("li",[n("p",[s._v("而在多CPU系统中，可以让两个以上的线程同时运行，这种可以同时让两个以上线程同时运行的方式叫做并行")])])])]),s._v(" "),n("li",[n("p",[s._v("第二种")])])]),s._v(" "),n("p",[s._v("你吃饭吃到一半，电话来了，你一直到吃完了以后才去接，这就说明你不支持并发也不支持并行。\n你吃饭吃到一半，电话来了，你停了下来接了电话，接完后继续吃饭，这说明你支持并发。\n你吃饭吃到一半，电话来了，你一边打电话一边吃饭，这说明你支持并行。")]),s._v(" "),n("p",[s._v("并发的关键是你有处理多个任务的能力，不一定要同时。\n并行的关键是你有同时处理多个任务的能力。")]),s._v(" "),n("p",[s._v("关键的点就是：是否是『同时』。")]),s._v(" "),n("h3",{attrs:{id:"同步-重要"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#同步-重要"}},[s._v("#")]),s._v(" 同步(重要)")]),s._v(" "),n("p",[s._v("在并发中，我们可以将同步定义为一种协调两个或更多任务以获得预期结果的机制。同步的方式有两种：")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("控制同步：例如，当一个任务的开始依赖于另一个任务的结束时，第二个任务不能在第一个任务完成之前开始。")])]),s._v(" "),n("li",[n("p",[s._v("数据访问同步：当两个或更多任务访问共享变量时，在任意时间里，只有一个任务可以访问该变量。")])])]),s._v(" "),n("p",[s._v("与同步密切相关的一个概念是临界段。临界段是一段代码，由于它可以访问共享资源，因此在任何给定时间内，只能被一个任务执行。"),n("strong",[s._v("互斥")]),s._v("是用来保证这一要求的机制，而且可以采用不同的方式来实现。")]),s._v(" "),n("p",[s._v("并发系统中有不同的同步机制。从理论角度看，最流行的机制如下：")]),s._v(" "),n("ul",[n("li",[n("p",[n("strong",[s._v("信号量")]),s._v("（semaphore）：一种用于控制对一个或多个单位资源进行访问的机制。它有一个用于存放可用资源数量的变量，而且可以采用两种原子操作来管理该变量。互斥（mutex，mutual exclusion的简写形式）是一种特殊类型的信号量，它只能取两个值（即"),n("strong",[s._v("资源空闲")]),s._v("和"),n("strong",[s._v("资源忙")]),s._v("），而且只有将互斥设置为忙的那个进程才可以释放它。互斥可以通过保护临界段来帮助你避免出现竞争条件。")])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("监视器")]),s._v("：一种在共享资源上实现互斥的机制。它有一个互斥、一个条件变量、两种操作（等待条件和通报条件）。一旦你通报了该条件，在等待它的任务中只有一个会继续执行。如果共享数据的所有用户都受到同步机制的保护，那么代码（或方法、对象）就是"),n("strong",[s._v("线程安全")]),s._v("的。数据的非阻塞的CAS（compare-and-swap，比较和交换）原语是不可变的，这样就可以在并发应用程序中使用该代码而不会出任何问题。")])])]),s._v(" "),n("h3",{attrs:{id:"不可变对象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#不可变对象"}},[s._v("#")]),s._v(" 不可变对象")]),s._v(" "),n("p",[n("strong",[s._v("不可变对象")]),s._v("是一种非常特殊的对象。在其初始化后，不能修改其可视状态（其属性值）。如果想修改一个不可变对象，那么你就必须创建一个新的对象。")]),s._v(" "),n("p",[s._v("不可变对象的主要优点在于它是"),n("code",[s._v("线程安全")]),s._v("的。你可以在并发应用程序中使用它而不会出现任何问题。")]),s._v(" "),n("p",[s._v("不可变对象的一个例子就是java中的String类。当你给一个String对象赋新值时，会创建一个新的String对象。")]),s._v(" "),n("h3",{attrs:{id:"原子操作和原子变量"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#原子操作和原子变量"}},[s._v("#")]),s._v(" 原子操作和原子变量")]),s._v(" "),n("p",[s._v("与应用程序的其他任务相比，"),n("strong",[s._v("原子操作")]),s._v("是一种发生在瞬间的操作。在并发应用程序中，可以通过一个临界段来实现原子操作，以便对整个操作采用同步机制。")]),s._v(" "),n("p",[n("strong",[s._v("原子变量")]),s._v("是一种通过原子操作来设置和获取其值的变量。可以使用某种同步机制来实现一个原子变量，或者也可以使用CAS以无锁方式来实现一个原子变量，而这种方式并不需要任何同步机制。")]),s._v(" "),n("h3",{attrs:{id:"共享内存与消息传递-重要"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#共享内存与消息传递-重要"}},[s._v("#")]),s._v(" 共享内存与消息传递(重要)")]),s._v(" "),n("p",[s._v("任务可以通过两种不同的方式来相互通信。")]),s._v(" "),n("ul",[n("li",[n("p",[n("strong",[s._v("共享内存")]),s._v("，通常用于在同一台计算机上运行多任务的情况。任务在读取和写入值的时候使用相同的内存区域。为了避免出现问题，对该共享内存的访问必须在一个由同步机制保护的临界段内完成。")])]),s._v(" "),n("li",[n("p",[n("strong",[s._v("消息传递")]),s._v("，通常用于在不同计算机上运行多任务的情形。当一个任务需要与另一个任务通信时，它会发送一个遵循预定义协议的消息。如果发送方保持阻塞并等待响应，那么该通信就是同步的；如果发送方在发送消息后继续执行自己的流程，那么该通信就是异步的。")])])]),s._v(" "),n("h2",{attrs:{id:"并发的问题-了解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#并发的问题-了解"}},[s._v("#")]),s._v(" 并发的问题(了解)")]),s._v(" "),n("h3",{attrs:{id:"数据竞争"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#数据竞争"}},[s._v("#")]),s._v(" 数据竞争")]),s._v(" "),n("p",[s._v("如果有两个或者多个任务在临界段之外对一个共享变量进行写入操作，也就是说没有使用任何同步机制，那么应用程序可能存在"),n("strong",[s._v("数据竞争")]),s._v("（也叫做"),n("strong",[s._v("竞争条件")]),s._v("）。")]),s._v(" "),n("p",[s._v("在这些情况下，应用程序的最终结果可能取决于任务的执行顺序。")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ConcurrentDemo")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n    \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("float")]),s._v(" myFloat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n    \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("modify")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("float")]),s._v(" difference"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n        \n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("float")]),s._v(" value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("myFloat"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("myFloat "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" value "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" difference"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        \n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("h3",{attrs:{id:"死锁"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#死锁"}},[s._v("#")]),s._v(" 死锁")]),s._v(" "),n("p",[s._v("当两个（或多个）任务正在等待必须由另一线程释放的某个共享资源，而该线程又正在等待必须由前述任务之一释放的另一共享资源时，并发应用程序就出现了死锁。当系统中同时出现如下四种条件时，就会导致这种情形。我们将其称为Coffman 条件。")]),s._v(" "),n("ul",[n("li",[s._v("互斥： 死锁中涉及的资源、必须是不可共享的。一次只有一个任务可以使用该资源。")]),s._v(" "),n("li",[s._v("占有并等待条件： 一个任务在占有某一互斥的资源时又请求另一互斥的资源。当它在等待时，不会释放任何资源。")]),s._v(" "),n("li",[s._v("不可剥夺：资源只能被那些持有它们的任务释放。")]),s._v(" "),n("li",[s._v("循环等待：任务1正等待任务2 所占有的资源， 而任务2 又正在等待任务3 所占有的资源，以此类推，最终任务n又在等待由任务1所占有的资源，这样就出现了循环等待。")])]),s._v(" "),n("p",[s._v("有一些机制可以用来避免死锁。")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("忽略它们：这是最常用的机制。你可以假设自己的系统绝不会出现死锁，而如果发生死锁，结果就是你可以停止应用程序并且重新执行它。")])]),s._v(" "),n("li",[n("p",[s._v("检测：系统中有一项专门分析系统状态的任务，可以检测是否发生了死锁。如果它检测到了死锁，可以采取一些措施来修复该问题，例如，结束某个任务或者强制释放某一资源。")])]),s._v(" "),n("li",[n("p",[s._v("预防：如果你想防止系统出现死锁，就必须预防Coffman 条件中的一条或多条出现")])]),s._v(" "),n("li",[n("p",[s._v("规避：如果你可以在某一任务执行之前得到该任务所使用资源的相关信息，那么死锁是可以规避的。当一个任务要开始执行时，你可以对系统中空闲的资源和任务所需的资源进行分析，这样就可以判断任务是否能够开始执行。")])])]),s._v(" "),n("h3",{attrs:{id:"活锁"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#活锁"}},[s._v("#")]),s._v(" 活锁")]),s._v(" "),n("p",[s._v("如果系统中有两个任务，它们总是因对方的行为而改变自己的状态， 那么就出现了活锁。最终结果是它们陷入了状态变更的循环而无法继续向下执行。")]),s._v(" "),n("p",[s._v("例如，有两个任务：任务1和任务2 ，它们都需要用到两个资源：资源1和资源2 。假设任务1对资源1加了一个锁，而任务2 对资源2 加了一个锁。当它们无法访问所需的资源时，就会释放自己的资源并且重新开始循环。这种情况可以无限地持续下去，所以这两个任务都不会结束自己的执行过程。")]),s._v(" "),n("h3",{attrs:{id:"资源不足"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#资源不足"}},[s._v("#")]),s._v(" 资源不足")]),s._v(" "),n("p",[s._v("当某个任务在系统中无法获取维持其继续执行所需的资源时，就会出现资源不足。当有多个任务在等待某一资源且该资源被释放时，系统需要选择下一个可以使用该资源的任务。如果你的系统中没有设计良好的算法，那么系统中有些线程很可能要为获取该资源而等待很长时间。")]),s._v(" "),n("p",[s._v("要解决这一问题就要确保公平原则。所有等待某一资源的任务必须在某一给定时间之内占有该资源。可选方案之一就是实现一个算法，在选择下一个将占有某一资源的任务时，对任务已等待该资源的时间因素加以考虑。然而，实现锁的公平需要增加额外的开销，这可能会降低程序的吞吐量。")]),s._v(" "),n("h3",{attrs:{id:"优先权反转"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优先权反转"}},[s._v("#")]),s._v(" 优先权反转")]),s._v(" "),n("p",[s._v("当一个低优先权的任务持有了一个高优先级任务所需的资源时，就会发生优先权反转。这样的话，低优先权的任务就会在高优先权的任务之前执行。")]),s._v(" "),n("h2",{attrs:{id:"java内存模型-jmm-重要"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#java内存模型-jmm-重要"}},[s._v("#")]),s._v(" java内存模型(JMM) 重要")]),s._v(" "),n("h3",{attrs:{id:"jmm概述"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#jmm概述"}},[s._v("#")]),s._v(" JMM概述")]),s._v(" "),n("p",[s._v("出现线程安全的问题一般是因为"),n("strong",[s._v("主内存和工作内存数据不一致性")]),s._v("和"),n("strong",[s._v("重排序")]),s._v("导致的，而解决线程安全的问题最重要的就是理解这两种问题是怎么来的，那么，理解它们的核心在于理解java内存模型（JMM）。")]),s._v(" "),n("p",[s._v("Java 的并发采用的是"),n("strong",[s._v("共享内存模型")]),s._v("，Java 线程之间的通信总是隐式进行，整个通信过程对程序员完全透明。如果编写多线程程序的 Java 程序员不理解隐式进行的线程之间通信的工作机制，很可能会遇到各种奇怪的内存可见性问题。我们需要处理两个关键问题："),n("code",[s._v("线程之间如何通信及线程之间如何同步")]),s._v("（这里的线程是指并发执行的活动实体）。通信是指线程之间以何种机制来交换信息。紧接着我们需要知道java中那些是共享内存")]),s._v(" "),n("p",[n("strong",[s._v("共享变量与局部变量")])]),s._v(" "),n("ul",[n("li",[n("p",[s._v("共享变量：在 java 中，所有"),n("code",[s._v("实例域、静态域和数组元素存储在堆内存中，堆内存在线程之间共享")]),s._v("。")])]),s._v(" "),n("li",[n("p",[s._v("局部变量（Local variables）, 方法定义参数（java 语言规范称之为 formal method parameters）和异常处理器参数（exception handler parameters）不会在线程之间共享，它们不会有内存可见性问题，也不受内存模型的影响。")])])]),s._v(" "),n("h3",{attrs:{id:"jmm内存模型抽象"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#jmm内存模型抽象"}},[s._v("#")]),s._v(" JMM内存模型抽象")]),s._v(" "),n("p",[n("code",[s._v("Java 线程之间的通信由 Java 内存模型(JMM java method model)控制，JMM 决定一个线程对共享变量的写入何时对另一个线程可见。")]),s._v("从抽象的角度来看，JMM 定义了线程和主内存之间的抽象关系：线程之间的共享变量存储在主内存（main memory）中，每个线程都有一个私有的本地内存（local memory），本地内存中存储了该线程以读 / 写共享变量的副本。本地内存是 JMM 的一个抽象概念，并不真实存在。它涵盖了缓存，写缓冲区，寄存器以及其他的硬件和编译器优化。")]),s._v(" "),n("p",[s._v("Java 内存模型的抽象示意图如下：")]),s._v(" "),n("p",[n("img",{attrs:{src:t(506),alt:"java-jmm-1"}})]),s._v(" "),n("p",[s._v("从上图来看，线程 A 与线程 B 之间如要通信的话，必须要经历下面 2 个步骤：")]),s._v(" "),n("ul",[n("li",[s._v("首先，线程 A 把本地内存 A 中更新过的共享变量刷新到主内存中去。")]),s._v(" "),n("li",[s._v("然后，线程 B 到主内存中去读取线程 A 之前已更新过的共享变量。")])]),s._v(" "),n("p",[s._v("线程A和线程B通过共享变量在进行"),n("code",[s._v("隐式通信")]),s._v("。如果线程A更新后数据并没有及时写回到主存，而此时线程B读到的是过期的数据，这就出现了"),n("code",[s._v("“脏读”")]),s._v("现象。可以通过同步机制（控制不同线程间操作发生的相对顺序）来解决或者通过volatile关键字使得每次volatile变量都能够强制刷新到主存，从而对每个线程都是可见的。")]),s._v(" "),n("h3",{attrs:{id:"重排序-重要"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#重排序-重要"}},[s._v("#")]),s._v(" 重排序(重要)")]),s._v(" "),n("p",[s._v("一个好的内存模型实际上会放松对处理器和编译器规则的束缚，也就是说软件技术和硬件技术都为同一个目标而进行奋斗："),n("code",[s._v("在不改变程序执行结果的前提下，尽可能提高并行度。")]),s._v("JMM对底层尽量减少约束，使其能够发挥自身优势。因此，在执行程序时，"),n("strong",[s._v("为了提高性能，编译器和处理器常常会对指令进行重排序")]),s._v("。")]),s._v(" "),n("p",[s._v("Store Buffer的延迟写入是重排序的一种，称为内存重排序（Memory Ordering）。除此之外，还有编译器和CPU的指令重排序。")]),s._v(" "),n("p",[n("img",{attrs:{src:t(507),alt:"java-jmm-2"}})]),s._v(" "),n("ol",[n("li",[n("p",[s._v("编译器重排序。")]),s._v(" "),n("p",[s._v("对于没有先后依赖关系的语句，编译器可以重新调整语句的执行顺序。")])]),s._v(" "),n("li",[n("p",[s._v("CPU指令重排序。")]),s._v(" "),n("p",[s._v("在指令级别，让没有依赖关系的多条指令并行。")])]),s._v(" "),n("li",[n("p",[s._v("CPU内存重排序。")]),s._v(" "),n("p",[s._v("CPU有自己的缓存，指令的执行顺序和写入主内存的顺序不完全一致。")])])]),s._v(" "),n("p",[s._v("**1属于编译器重排序，而2和3统称为CPU处理器重排序。**这些重排序会导致线程安全的问题，一个很经典的例子就是DCL问题.")]),s._v(" "),n("p",[n("img",{attrs:{src:t(508),alt:"java-jmm-3"}})]),s._v(" "),n("p",[s._v("假设：X、Y是两个全局变量，初始的时候，X，Y是全局变量并 X=0，Y=0。  线程A,B 分别执行各自的值。"),n("code",[s._v("线程1和线程2的执行先后顺序是不确定的，可能顺序执行，也可能交叉执行")]),s._v("，这就造成内存可见性问题。可能会出现结果可能是：")]),s._v(" "),n("ol",[n("li",[s._v("a=0,b=1")]),s._v(" "),n("li",[s._v("a=1,b=0")]),s._v(" "),n("li",[s._v("a=1,b=1")])]),s._v(" "),n("p",[s._v("对于编译器，JMM 的编译器重排序规则会"),n("code",[s._v("禁止特定类型的编译器重排序")]),s._v("（不是所有的编译器重排序都要禁止）。对于CPU处理器重排序，"),n("code",[s._v("JMM 的处理器重排序规则会要求 java 编译器在生成指令序列时，插入特定类型的内存屏障指令，")]),s._v("通过内存屏障指令来禁止特定类型的处理器重排序`（不是所有的处理器重排序都要禁止）。")]),s._v(" "),n("h3",{attrs:{id:"内存屏障-了解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#内存屏障-了解"}},[s._v("#")]),s._v(" 内存屏障（了解）")]),s._v(" "),n("p",[s._v("为了禁止编译器重排序和 CPU 重排序，在编译器和 CPU 层面都有对应的指令，也就是"),n("code",[s._v("内存屏障")]),s._v("（Memory Barrier）。这也正是JMM和happen-before规则的底层实现原理。")]),s._v(" "),n("p",[s._v("编译器的内存屏障，只是为了告诉编译器不要对指令进行重排序。当编译完成之后，这种内存屏障就消失了，CPU并不会感知到编译器中内存屏障的存在。")]),s._v(" "),n("p",[s._v("而CPU的内存屏障是CPU提供的指令，可以由开发者显示调用。内存屏障是很底层的概念，对于 Java 开发者来说，一般用 "),n("code",[s._v("volatile 关键字")]),s._v("就足够了。但从JDK 8开始，Java在Unsafe类中提供了三个内存屏障函数，如下所示。")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Unsafe")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ... ")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("native")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("loadFence")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("native")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("storeFence")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("native")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fullFence")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("在理论层面，可以把基本的CPU内存屏障分成四种：")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("LoadLoad：禁止读和读的重排序。")])]),s._v(" "),n("li",[n("p",[s._v("StoreStore：禁止写和写的重排序。")])]),s._v(" "),n("li",[n("p",[s._v("LoadStore：禁止读和写的重排序。")])]),s._v(" "),n("li",[n("p",[s._v("StoreLoad：禁止写和读的重排序。")])])]),s._v(" "),n("p",[s._v("Unsafe中的方法：")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("loadFence=LoadLoad+LoadStore")])]),s._v(" "),n("li",[n("p",[s._v("storeFence=StoreStore+LoadStore")])]),s._v(" "),n("li",[n("p",[s._v("fullFence=loadFence+storeFence+StoreLoad")])])]),s._v(" "),n("h3",{attrs:{id:"as-if-serial语义-了解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#as-if-serial语义-了解"}},[s._v("#")]),s._v(" as-if-serial语义(了解)")]),s._v(" "),n("p",[s._v("as-if-serial语义的意思是："),n("code",[s._v("不管怎么重排序（编译器和处理器为了提供并行度），（单线程）程序的执行结果不能被改变。")])]),s._v(" "),n("p",[s._v("重排序的原则是什么？什么场景下可以重排序，什么场景下不能重排序呢？")]),s._v(" "),n("ol",[n("li",[n("strong",[s._v("单线程程序的重排序规则")])])]),s._v(" "),n("p",[s._v("无论什么语言，站在编译器和CPU的角度来说，"),n("code",[s._v("不管怎么重排序，单线程程序的执行结果不能改变，这就是单线程程序的重排序规则")]),s._v("。")]),s._v(" "),n("p",[s._v("即只要操作之间没有数据依赖性，编译器和CPU都可以任意重排序，因为执行结果不会改变，代码看起来就像是完全串行地一行行从头执行到尾，这也就是as-if-serial语义。")]),s._v(" "),n("p",[s._v("对于单线程程序来说，编译器和CPU可能做了重排序，但开发者感知不到，也不存在内存可见性问题。")]),s._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[n("strong",[s._v("多线程程序的重排序规则")])])]),s._v(" "),n("p",[s._v("编译器和CPU的这一行为对于单线程程序没有影响，但对多线程程序却有影响。")]),s._v(" "),n("p",[s._v("对于多线程程序来说，线程之间的数据依赖性太复杂，编译器和CPU没有办法完全理解这种依赖性并据此做出最合理的优化。")]),s._v(" "),n("p",[s._v("编译器和CPU只能保证"),n("strong",[s._v("每个线程的as-if-serial语义")]),s._v("。")]),s._v(" "),n("p",[s._v("线程之间的数据依赖和相互影响，需要编译器和CPU的上层来确定。")]),s._v(" "),n("p",[s._v("上层要告知编译器和CPU在多线程场景下什么时候可以重排序，什么时候不能重排序。")]),s._v(" "),n("h3",{attrs:{id:"happens-before定义"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#happens-before定义"}},[s._v("#")]),s._v(" happens-before定义")]),s._v(" "),n("p",[n("strong",[s._v("JMM可以通过happens-before关系向程序员提供跨线程的内存可见性保证")]),s._v("这两个操作既可以是在一个线程之内，也可以是在不同线程之间。")]),s._v(" "),n("hr"),s._v(" "),n("ul",[n("li",[n("p",[s._v("如果一个操作happens-before另一个操作，那么第一个操作的执行结果将对第二个操作可见，而且第一个操作的执行顺序排在第二个操作之前。")])]),s._v(" "),n("li",[n("p",[s._v("两个操作之间存在happens-before关系，并不意味着Java平台的具体实现必须要按照happens-before关系指定的顺序来执行。如果重排序之后的执行结果，与按happens-before关系来执行的结果一致，那么这种重排序并不非法（也就是说，JMM允许这种重排序）。")])])]),s._v(" "),n("p",[s._v("上面的"),n("strong",[s._v("1）是JMM对程序员的承诺")]),s._v("。从程序员的角度来说，可以这样理解happens-before关系：如果A happens-before B，那么Java内存模型将向程序员保证——A操作的结果将对B可见，且A的执行顺序排在B之前。注意，这只是Java内存模型向程序员做出的保证！")]),s._v(" "),n("p",[s._v("上面的"),n("strong",[s._v("2）是JMM对编译器和处理器重排序的约束原则")]),s._v("。正如前面所言，JMM其实是在遵循一个基本原则：只要不改变程序的执行结果（指的是"),n("code",[s._v("单线程程序和正确同步的多线程程序")]),s._v("），编译器和处理器怎么优化都行。JMM这么做的原因是：程序员对于这两个操作是否真的被重排序并不关心，程序员关心的是程序执行时的语义不能被改变（即执行结果不能被改变）。因此，happens-before关系本质上和as-if-serial语义是一回事。")]),s._v(" "),n("hr"),s._v(" "),n("p",[n("strong",[s._v("as-if-serial和happens-before的区别")])]),s._v(" "),n("ol",[n("li",[s._v("as-if-serial语义保证单线程内程序的执行结果不被改变，happens-before关系保证正确同步的多线程程序的执行结果不被改变。")]),s._v(" "),n("li",[s._v("as-if-serial语义给编写单线程程序的程序员创造了一个幻境：单线程程序是按程序的顺序来执行的。happens-before关系给编写正确同步的多线程程序的程序员创造了一个幻境：正确同步的多线程程序是按happens-before指定的顺序来执行的。")]),s._v(" "),n("li",[s._v("as-if-serial语义和happens-before这么做的目的，"),n("code",[s._v("都是为了在不改变程序执行结果的前提下，尽可能地提高程序执行的并行度")]),s._v("。")])]),s._v(" "),n("h3",{attrs:{id:"happens-before规则-了解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#happens-before规则-了解"}},[s._v("#")]),s._v(" happens-before规则(了解)")]),s._v(" "),n("ol",[n("li",[s._v("程序顺序规则：一个线程中的每个操作，happens-before于该线程中的任意后续操作。")]),s._v(" "),n("li",[s._v("监视器锁规则：对一个锁的解锁，happens-before于随后对这个锁的加锁。")]),s._v(" "),n("li",[s._v("volatile变量规则：对一个volatile域的写，happens-before于任意后续对这个volatile域的读。")]),s._v(" "),n("li",[s._v("传递性：如果A happens-before B，且B happens-before C，那么A happens-before C。")]),s._v(" "),n("li",[s._v("start()规则：如果线程A执行操作ThreadB.start()（启动线程B），那么A线程的ThreadB.start()操作happens-before于线程B中的任意操作。")]),s._v(" "),n("li",[s._v("join()规则：如果线程A执行操作ThreadB.join()并成功返回，那么线程B中的任意操作happens-before于线程A从ThreadB.join()操作成功返回。")]),s._v(" "),n("li",[s._v("程序中断规则：对线程interrupted()方法的调用先行于被中断线程的代码检测到中断时间的发生。")]),s._v(" "),n("li",[s._v("对象finalize规则：一个对象的初始化完成（构造函数执行结束）先行于发生它的finalize()方法的开始。")])]),s._v(" "),n("h3",{attrs:{id:"happens-before值传递-了解"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#happens-before值传递-了解"}},[s._v("#")]),s._v(" happens-before值传递(了解)")]),s._v(" "),n("p",[s._v("这些基本的happen-before规则，happen-before还具有"),n("strong",[s._v("传递性")]),s._v("，即若A happen-before B，Bhappen-before C，则A happen-before C。")]),s._v(" "),n("p",[s._v("举例：")]),s._v(" "),n("ul",[n("li",[s._v("volatile")])]),s._v(" "),n("p",[s._v("如果一个变量不是volatile变量，当一个线程读取、一个线程写入时可能有问题。那岂不是说，在多线程程序中，我们要么加锁，要么必须把所有变量都声明为volatile变量？这显然不可能，而这就得归功于"),n("strong",[s._v("happen-before的传递性")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" a "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("volatile")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" c "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n        a "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作1 ")]),s._v("\n        c "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作2 ")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" d "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" c"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作3 ")]),s._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" a"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作4 ")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br")])]),n("p",[s._v("​\t\t操作1和操作2是在同一个线程内存中执行的，操作1 happen-before 操作2，同理，操作3 happen,before操作4。又因为c是volatile变量，对c的写入happen-before对c的读取，所以操作2 happen，before操作3。利用happen-before的传递性，就得到：")]),s._v(" "),n("p",[s._v("​\t\t"),n("code",[s._v("操作1 happen-before 操作2 happen-before 操作3 happen-before操作4。")])]),s._v(" "),n("ul",[n("li",[s._v("synchronized")])]),s._v(" "),n("p",[s._v("因为与volatile一样，"),n("strong",[s._v("synchronized同样具有happen-before语义")]),s._v("。展开上面的代码可得到类似于下面的伪代码：")]),s._v(" "),n("div",{staticClass:"language-java line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("A")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" a "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" c "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("set")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        a "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作1 ")]),s._v("\n        c "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 操作2 ")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" a"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" \n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h3",{attrs:{id:"jmm的设计-重要"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#jmm的设计-重要"}},[s._v("#")]),s._v(" JMM的设计(重要)")]),s._v(" "),n("p",[s._v("上面已经聊了关于JMM的两个方面：1. JMM的抽象结构（主内存和线程工作内存）；2. 重排序以及happens-before规则。")]),s._v(" "),n("p",[n("img",{attrs:{src:t(509),alt:"java-jmm-4"}})]),s._v(" "),n("ul",[n("li",[s._v("上层会有基于JMM的关键字和J.U.C包下的一些具体类用来方便程序员能够迅速高效率的进行并发编程。")]),s._v(" "),n("li",[s._v("JMM处于中间层，包含了两个方面：1. 内存模型；2.重排序以及happens-before规则。为了禁止特定类型的重排序会对编译器和处理器指令序列加以控制。")])]),s._v(" "),n("p",[s._v("在设计JMM时需要考虑两个"),n("code",[s._v("关键因素")]),s._v(":")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("程序员对内存模型的使用")]),s._v(" 程序员希望内存模型易于理解、易于编程。程序员希望基于一个强内存模型来编写代码")]),s._v(" "),n("li",[n("strong",[s._v("编译器和处理器对内存模型的实现")]),s._v(" 编译器和处理器希望内存模型对它们的束缚越少越好，这样它们就可以做尽可能多的优化来提高性能。编译器和处理器希望实现一个弱内存模型。")])]),s._v(" "),n("p",[s._v("JMM 把 happens- before 要求禁止的重排序分为了下面两类：")]),s._v(" "),n("ul",[n("li",[s._v("会改变程序执行结果的重排序。")]),s._v(" "),n("li",[s._v("不会改变程序执行结果的重排序。")])]),s._v(" "),n("p",[s._v("JMM 对这两种不同性质的重排序，采取了不同的策略：")]),s._v(" "),n("ul",[n("li",[s._v("对于会改变程序执行结果的重排序，JMM 要求编译器和处理器必须禁止这种重排序。")]),s._v(" "),n("li",[s._v("对于不会改变程序执行结果的重排序，JMM 对编译器和处理器不作要求（JMM 允许这种重排序）")])]),s._v(" "),n("p",[n("img",{attrs:{src:t(510),alt:"java-jmm-5"}})]),s._v(" "),n("p",[s._v("从上图可以看出两点：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("JMM 向程序员提供的 happens- before 规则能满足程序员的需求")]),s._v("。JMM 的 happens- before 规则不但简单易懂，而且也向程序员提供了足够强的内存可见性保证（有些内存可见性保证其实并不一定真实存在，比如上面的 A happens- before B）。")]),s._v(" "),n("li",[n("code",[s._v("JMM 对编译器和处理器的束缚已经尽可能的少")]),s._v("。从上面的分析我们可以看出，JMM 其实是在遵循一个基本原则："),n("strong",[s._v("只要不改变程序的执行结果（指的是单线程程序和正确同步的多线程程序），编译器和处理器怎么优化都行")]),s._v("。比如，如果编译器经过细致的分析后，认定一个锁只会被单个线程访问，那么这个锁可以被消除。再比如，如果编译器经过细致的分析后，认定一个 volatile 变量仅仅只会被单个线程访问，那么编译器可以把这个 volatile 变量当作一个普通变量来对待。这些优化既不会改变程序的执行结果，又能提高程序的执行效率。")])]),s._v(" "),n("h3",{attrs:{id:"jmm-的内存可见性保证-重要"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#jmm-的内存可见性保证-重要"}},[s._v("#")]),s._v(" JMM 的内存可见性保证(重要)")]),s._v(" "),n("p",[s._v("Java 程序的内存可见性保证按程序类型可以分为下列三类：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("单线程程序")]),s._v("。单线程程序不会出现内存可见性问题。编译器，runtime 和处理器会共同确保单线程程序的执行结果与该程序在顺序一致性模型中的执行结果相同。")]),s._v(" "),n("li",[n("strong",[s._v("正确同步的多线程程序")]),s._v("。正确同步的多线程程序的执行将具有顺序一致性（程序的执行结果与该程序在顺序一致性内存模型中的执行结果相同）。这是 JMM 关注的重点，JMM 通过限制编译器和处理器的重排序来为程序员提供内存可见性保证。")]),s._v(" "),n("li",[n("strong",[s._v("未同步 / 未正确同步的多线程程序")]),s._v("。JMM 为它们提供了最小安全性保障：线程执行时读取到的值，要么是之前某个线程写入的值，要么是默认值（0，null，false）。")])]),s._v(" "),n("p",[s._v("下图展示了这三类程序在 JMM 中与在顺序一致性内存模型中的执行结果的异同：")]),s._v(" "),n("p",[n("img",{attrs:{src:t(511),alt:"java-jmm-06"}})]),s._v(" "),n("p",[n("strong",[s._v("标注：在学习中需要修改的内容以及笔记全在这里 "),n("a",{attrs:{href:"https://juejin.cn/post/www.javanode.cn",target:"_blank",rel:"noopener noreferrer"}},[s._v("www.javanode.cn"),n("OutboundLink")],1),s._v("，谢谢！有任何不妥的地方望纠正")])])])}),[],!1,null,null,null);a.default=e.exports}}]);